# lab4 实验报告

#### 陈家豪 19307130210



## 任务一

mmio_map_region的作用是在MMIO中分配size bytes大小，并将虚拟地址[base,base+size]映射到物理地址[pa,pa+size]。base最初是MMIOBASE，在成功映射后变为base+size，随着对该函数的调用而变化。函数返回值为虚拟地址的起始，即最开始的base

映射过程调用了函数boot_map_region(kern_pgdir, base, size, pa, PTE_PCD | PTE_PWT | PTE_W)，

kern_pgdir为页表目录，将虚拟地址[base,base+size]映射到物理地址[pa,pa+size]。

函数原理为，先求分配的页数pgs，再有如下：

```
for (int i = 0; i < pgs; i++)
	{
		pte_t *pte = pgdir_walk(pgdir, (void *)va, 1);
		if (pte == NULL)
		{
			panic("boot_map_region(): out of memory\n");
		}
		*pte = pa | PTE_P | perm;
		pa += PGSIZE;
		va += PGSIZE;
	}
```

pgdir_walk的作用是返回一个PTE的指针，然后在这个PTE上存放pa | PTE_P | perm，之后pa,va递增PGSIZE，存放下一个PTE。构建了页表。





## 任务二



// Physical address of startup code for non-boot CPUs (APs)

\#define MPENTRY_PADDR  0x7000





#define MPBOOTPHYS(s) ((s) - mpentry_start + MPENTRY_PADDR)